<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>32C3 CTF - Flash (Reversing 300) &#8211; NUS Greyhats</title>
<meta name="description" content="32C3 CTF - Flash. Reversing - 300 Points">
<meta name="keywords" content="CTF, REVERSING, 32C3, REGEX">

  

<!-- Twitter Cards -->
<meta name="twitter:title" content="32C3 CTF - Flash (Reversing 300)">
<meta name="twitter:description" content="32C3 CTF - Flash. Reversing - 300 Points">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="//nusgreyhats.github.io/write-ups/images/icon.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="32C3 CTF - Flash (Reversing 300)">
<meta property="og:description" content="32C3 CTF - Flash. Reversing - 300 Points">
<meta property="og:url" content="//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/">
<meta property="og:site_name" content="NUS Greyhats">





<link rel="canonical" href="//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/">
<link href="//nusgreyhats.github.io/write-ups/feed.xml" type="application/atom+xml" rel="alternate" title="NUS Greyhats Feed">

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="//nusgreyhats.github.io/write-ups/assets/css/main.css">
<!-- Webfonts -->
<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="//nusgreyhats.github.io/write-ups/assets/js/vendor/html5shiv.min.js"></script>
  <script src="//nusgreyhats.github.io/write-ups/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<link href="//nusgreyhats.github.io/write-ups/assets/css/font-awesome.css" rel="stylesheet" type="text/css">
<script src="//nusgreyhats.github.io/write-ups/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="//nusgreyhats.github.io/write-ups/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="//nusgreyhats.github.io/write-ups/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav class="main-nav-outer animated drop" id="site-nav"><!--main-nav-start-->
		    <ul class="main-nav">
		        <li class="small-logo"><a href="//nusgreyhats.github.io/write-ups/../#header"><img src="//nusgreyhats.github.io/write-ups/images/icon.png" alt=""></a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/">Write Ups</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#security-wednesdays">Security Wednesdays</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#the-ctf">The CTF</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#team">Team</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#contact">Contact</a></li>

		        
		        <li class="social">
		            <a href="https://facebook.com/groups/nusgreyhats/" class="facebook"><i class="fa fa-facebook"></i></a>
		        </li>
		        
		    </ul>
	</nav>
</div>
	
<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="//nusgreyhats.github.io/write-ups/tags/#CTF" title="Pages tagged CTF">CTF</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#REVERSING" title="Pages tagged REVERSING">REVERSING</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#32C3" title="Pages tagged 32C3">32C3</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#REGEX" title="Pages tagged REGEX">REGEX</a></span>
        
          <h1 class="entry-title">32C3 CTF - Flash (Reversing 300)</h1>
        
      </header>
      <footer class="entry-meta">
        
          
              
          
              
          
              
                  
              
          
              
          
        
        
          <img src="//nusgreyhats.github.io/write-ups/images/bio-photo.jpg" class="bio-photo" alt="Quan Yang bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Quan Yang</span></span>
        <span class="entry-date date published"><time datetime="2015-12-31T00:00:00+08:00"><i class="fa fa-calendar-o"></i> December 31, 2015</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=CTF,REVERSING,32C3,REGEX&amp;text=32C3%20CTF%20-%20Flash%20(Reversing%20300)&amp;url=//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/&amp;via=https://twitter.com/quanyang" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <p>32C3 CTF is organized along with the Chaos Communication Congress in Hamburg, it started on Dec. 27, 20:00 UTC and lasted 48h until Dec. 29, 20:00 UTC.</p>

<h1 id="flash">Flash</h1>
<blockquote>
  <p><strong>Points:</strong> 300<br />
<strong>Category:</strong> Reversing<br />
<strong>Description</strong>
This <a href="https://32c3ctf.ccc.ac/uploads/flash.tgz">firmware image</a> is secured against manipulation using RSA and MD5. Can you still get around that protection? <br />
The service is available <a href="http://136.243.194.37:8001/upload.py">here</a>.</p>
</blockquote>

<hr />

<h1 id="our-solution">Our solution</h1>

<p><img src="//nusgreyhats.github.io/write-ups/resources/images/32c3ctf/firmware-upload.png" alt="" width="50%" /></p>

<p>We’re given a gzip compressed file, which includes a sample firmware, the public key and the firmware uploading service backend script.</p>

<p><img src="//nusgreyhats.github.io/write-ups/resources/images/32c3ctf/firmware-bin.png" alt="" width="50%" /></p>

<p>Running file on the firmware.bin shows that it is an archive. The signature file contained in it seems to be a digital signature that is used to ensure the authenticity of the firmware.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="gp">$ </span>file firmware.bin
firmware.bin: POSIX tar archive <span class="o">(</span>GNU<span class="o">)</span>
<span class="gp">$ </span>tar vxf firmware.bin
x ./CHANGELOG
x ./firmware.img
x ./install
x ./LICENSE
x ./README
x signature<span class="w">
</span></pre></td></tr></tbody></table>



We now take a look at the uploading service.


<div class="highlight"><pre><code class="language-python" data-lang="python"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101</pre></td><td class="code"><pre><span class="c">#!/usr/bin/env python2</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">cgitb</span><span class="p">;</span> <span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">Crypto.Signature</span> <span class="kn">import</span> <span class="n">PKCS1_v1_5</span>
<span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
<span class="kn">from</span> <span class="nn">Crypto.Hash</span> <span class="kn">import</span> <span class="n">MD5</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">embed</span>

<span class="k">class</span> <span class="nc">MD5_32C3</span><span class="p">:</span>
  <span class="n">oid</span> <span class="o">=</span> <span class="n">MD5</span><span class="o">.</span><span class="n">new</span><span class="p">()</span><span class="o">.</span><span class="n">oid</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">digest</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_digest_data</span> <span class="o">=</span> <span class="n">digest</span>
  <span class="k">def</span> <span class="nf">digest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_digest_data</span>

<span class="n">UPLOAD_DIR</span> <span class="o">=</span> <span class="s">"/tmp"</span>

<span class="n">HTML_FORM_TEMPLATE</span> <span class="o">=</span> <span class="s">"""
**truncated**
&lt;form action="" method="POST" enctype="multipart/form-data"&gt;
File: &lt;input name="file" type="file"&gt;&lt;br&gt;
&lt;input name="submit" type="submit" value="upload!"&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;"""</span>

<span class="n">HTML_STATUS_TEMPLATE</span> <span class="o">=</span> <span class="s">"""
**truncated**
&lt;h1&gt;Firmware Update Status&lt;/h1&gt;
</span><span class="si">%(status)</span><span class="s">s
&lt;/body&gt;
&lt;/html&gt;"""</span>

<span class="k">def</span> <span class="nf">print_html_form</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">"content-type: text/html</span><span class="se">\n</span><span class="s">"</span>
    <span class="k">print</span> <span class="n">HTML_FORM_TEMPLATE</span>

<span class="k">def</span> <span class="nf">print_html_status</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"content-type: text/html</span><span class="se">\n</span><span class="s">"</span>
    <span class="k">print</span> <span class="n">HTML_STATUS_TEMPLATE</span> <span class="o">%</span> <span class="p">{</span><span class="s">'status'</span><span class="p">:</span> <span class="n">status</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">save_firmware_image</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'CONTENT_LENGTH'</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">22</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">'file'</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">False</span>
    <span class="n">fileitem</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s">'file'</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fileitem</span><span class="o">.</span><span class="nb">file</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"hex"</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="n">fout</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s">'.bin'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">chunk</span> <span class="o">=</span> <span class="n">fileitem</span><span class="o">.</span><span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span> <span class="k">break</span>
      <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">filename</span>

<span class="k">def</span> <span class="nf">calc_md5</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">'mkdir '</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">'; cd '</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">'; md5calc &lt; '</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">'.bin | tar xv'</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">'[a-f0-9]{32}'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'hex'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">verify_sig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">expected_md5</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">signature</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s">'/signature'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span><span class="p">,</span><span class="s">'No signature found!'</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">pubkey</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'../rsa2048pub.pem'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span><span class="p">,</span><span class="s">'No pubkey found!'</span>
    <span class="n">expected_md5</span> <span class="o">=</span> <span class="n">MD5_32C3</span><span class="p">(</span><span class="n">expected_md5</span><span class="p">)</span>
    <span class="n">verifier</span> <span class="o">=</span> <span class="n">PKCS1_v1_5</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">pubkey</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">verifier</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">expected_md5</span><span class="p">,</span> <span class="n">signature</span><span class="p">),</span><span class="bp">None</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>
    <span class="n">print_html_form</span><span class="p">()</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">save_firmware_image</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
      <span class="n">print_html_status</span><span class="p">(</span><span class="s">'Invalid data received!'</span><span class="p">)</span>
      <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">md5</span> <span class="o">=</span> <span class="n">calc_md5</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">status</span><span class="p">,</span><span class="n">msg</span> <span class="o">=</span> <span class="n">verify_sig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">md5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s">'Signature check successul! Updating firmware... &lt;br&gt;'</span>
      <span class="n">cmd</span> <span class="o">=</span> <span class="s">'cd '</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">'; ./install'</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">'&lt;br&gt;done.'</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s">'Signature check failed!'</span>
    <span class="n">print_html_status</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table>



From the python script, we can tell that the verification process is as follows:
encrypt(md5(firmware.bin),public_key) == signature

The other interesting finding is the command `cmd = 'cd ' + filename + '; ./install'`. This tells us that we'll have to modify the file `install` to run arbitrary code in order to get the flag.

Simply modifying the firmware will not work, we need to find a way to bypass the signature check. As it is a reversing challenge, and that the RSA key is 2048-bits, I did not attempt to go towards the cryptography direction. 
Instead, what is interesting is the calc_md5 function.


<div class="highlight"><pre><code class="language-python" data-lang="python"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">calc_md5</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">'mkdir '</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">'; cd '</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">'; md5calc &lt; '</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">'.bin | tar xv'</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">'[a-f0-9]{32}'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'hex'</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table>



The function uses regular expression to obtain the MD5 from the output of the subprocess command, and what is interesting is that it takes the first occurance of a 32-characters a-f0-9 string as the MD5 hash (due to `re.search().group(0)`).


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="gp">$ </span>./md5calc &lt; firmware.bin | tar xv
name: ./CHANGELOG, size: 1812
name: ./firmware.img, size: 1048576
./CHANGELOG
./firmware.img
name: ./install, size: 44
name: ./LICENSE, size: 576
name: ./README, size: 930
name: signature, size: 256
nb override: 512
nb override: 512
md5: a0e3c9c3262ccf420c789ed55148412c
./install
./LICENSE
./README
signature<span class="w">
</span></pre></td></tr></tbody></table>



We see that if the firmware archive contains a file with the name of `a0e3c9c3262ccf420c789ed55148412c`, the calc_md5 will take that as the md5 hash instead of the actual md5 hash.


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></td><td class="code"><pre><span class="gp">$ </span>ls -la firmware3
total 4152
drwxr-xr-x 1 vagrant vagrant     374 Dec 31  2015 .
drwx------ 1 vagrant vagrant     714 Dec 31 10:56 ..
-rw-r--r-- 1 vagrant vagrant    6148 Dec 29 13:48 .DS_Store
-rw-r--r-- 1 vagrant vagrant 1055232 Dec 29 13:48 CHANGELOG
-rw-r--r-- 1 vagrant vagrant     576 Dec 26 22:37 LICENSE
-rw-r--r-- 1 vagrant vagrant     930 Dec 26 22:37 a0e3c9c3262ccf420c789ed55148412c
-rw-r--r-- 1 vagrant vagrant 1048576 Dec 26 22:37 firmware.img
-rw-r--r-- 1 vagrant vagrant 2114048 Dec 29 13:53 firmware3.bin
-rwxr-xr-x 1 vagrant vagrant      48 Dec 29 13:45 install
-rw-r--r-- 1 vagrant vagrant    2278 Dec 29 13:51 out.txt
-rw-r--r-- 1 vagrant vagrant     256 Dec 29 13:28 signature

<span class="gp">$ </span>python test.py firmware3
name: CHANGELOG, size: 1055232
name: LICENSE, size: 576
name: a0e3c9c3262ccf420c789ed55148412c, size: 930
name: firmware.img, size: 1048576
name: install, size: 48
name: signature, size: 256
nb override: 512
nb override: 512
md5: 8de5e3801c7758ba5e632b7c84533e8b

a0e3c9c3262ccf420c789ed55148412c
Signature check successul! Updating firmware... &lt;br&gt;&lt;br&gt;done.<span class="w">
</span></pre></td></tr></tbody></table>



With that, we can make use of multiple ways to obtain the flag located at `/home/challenge/flag.txt`. For me, I made use of nc to send the flag back.

![](//nusgreyhats.github.io/write-ups/resources/images/32c3ctf/flag.png){: width="100%"}

Hurray!
</code></pre></div></code></pre></div></code></pre></div></code></pre></div></code></pre></div>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'nusgreyhat';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="//nusgreyhats.github.io/write-ups/HITCONCTF-Quals-2015-Simple-(Crypto-100)/" class="btn" title="HITCON CTF Quals 2015 - Simple (Crypto 100)">Previous</a>
      
      
        <a href="//nusgreyhats.github.io/write-ups/INSOMNIHACK-CTF-Teaser-2016-Write-Up-Smartcat1/" class="btn" title="INSOMNIHACK CTF Teaser 2016 Write Up - Smartcat1">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->



<footer class="footer">
	<div class="container">
		<span class="copyright">© NUS GreyHats • Theme By W3Goods</span>
		<div class="social-icons">
			
			<a href="https://facebook.com/groups/nusgreyhats/" title="NUS Greyhats on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
			
			
			
			
			
			<a href="https://github.com/nusgreyhats" title="NUS Greyhats on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
			
			
			
			<a href="//nusgreyhats.github.io/write-ups/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
		</div><!-- /.social-icons -->
		<!--Copyright © 2014 Knight Theme By <a href="#">W3Goods</a>.-->
	</div>
</footer>


<script type="text/javascript">
  var BASE_URL = '//nusgreyhats.github.io/write-ups';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="//nusgreyhats.github.io/write-ups/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67874722-1', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>
